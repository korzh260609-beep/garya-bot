// === –ò–º–ø–æ—Ä—Ç—ã ===
import TelegramBot from "node-telegram-bot-api";
import express from "express";
import pool from "./db.js"; // –ø–∞–º—è—Ç—å + –ø—Ä–æ—Ñ–∏–ª–∏ + tasks
import * as Sources from "./sources.js"; // —Å–∫–µ–ª–µ—Ç —Å–ª–æ—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
import { classifyInteraction } from "./classifier.js"; // —Å–∫–µ–ª–µ—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞
import { callAI } from "./ai.js"; // —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ –ò–ò
import { buildSystemPrompt } from "./systemPrompt.js";
import { getProjectSection, upsertProjectSection } from "./projectMemory.js";

// === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===
const MAX_HISTORY_MESSAGES = 20;

// === –†–ï–ñ–ò–ú–´ –û–¢–í–ï–¢–û–í (answer_mode) ===
const DEFAULT_ANSWER_MODE = "short"; // –ø–æ –¢–ó —ç–∫–æ–Ω–æ–º–∏–º —Ç–æ–∫–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
// –í –±—É–¥—É—â–µ–º —ç—Ç–æ —É–π–¥—ë—Ç –≤ –ë–î, —Å–µ–π—á–∞—Å ‚Äî –ø—Ä–æ—Å—Ç–∞—è –∫–∞—Ä—Ç–∞ –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
const answerModeByChat = new Map(); // chatId (—Å—Ç—Ä–æ–∫–∞) -> "short" | "normal" | "long"

function getAnswerMode(chatIdStr) {
  return answerModeByChat.get(chatIdStr) || DEFAULT_ANSWER_MODE;
}

function setAnswerMode(chatIdStr, mode) {
  answerModeByChat.set(chatIdStr, mode);
}

// === PROJECT MEMORY HELPERS (3A) ===
async function loadProjectContext() {
  try {
    const roadmap = await getProjectSection(undefined, "roadmap");
    const workflow = await getProjectSection(undefined, "workflow");

    const parts = [];

    if (roadmap?.content) {
      parts.push(`ROADMAP:\n${roadmap.content}`);
    }

    if (workflow?.content) {
      parts.push(`WORKFLOW:\n${workflow.content}`);
    }

    if (parts.length === 0) {
      return "";
    }

    const fullText = parts.join("\n\n");
    // –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    return fullText.slice(0, 4000);
  } catch (err) {
    console.error("‚ùå loadProjectContext error:", err);
    return "";
  }
}

// === Express —Å–µ—Ä–≤–µ—Ä ===
const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json());

// === Telegram Bot ===
const token = process.env.TELEGRAM_BOT_TOKEN;

if (!token) {
  console.error("‚ùå TELEGRAM_BOT_TOKEN is missing!");
  console.error(
    "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN –∑–∞–¥–∞–Ω–∞ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞."
  );
  process.exit(1);
}

const bot = new TelegramBot(token);

// === Telegram Webhook ===
const WEBHOOK_URL = `https://garya-bot.onrender.com/webhook/${token}`;
bot.setWebHook(WEBHOOK_URL);

app.get("/", (req, res) => {
  res.send("GARYA AI Bot is alive! ‚ö°");
});

app.post(`/webhook/${token}`, (req, res) => {
  res.sendStatus(200);
  console.log("üì© Incoming webhook update:", JSON.stringify(req.body));
  try {
    bot.processUpdate(req.body);
  } catch (err) {
    console.error("‚ùå Error in bot.processUpdate:", err);
  }
});

app.get(`/webhook/${token}`, (req, res) => {
  console.log("üîé GET webhook ping");
  res.send("OK");
});

app.listen(PORT, () => {
  console.log("üåê Web server started on port:", PORT);

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–µ—Å—Ç—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (Sources Layer) ===
  Sources.ensureDefaultSources()
    .then(() => {
      console.log("üì° Sources: default templates are ready.");
    })
    .catch((err) => {
      console.error("‚ùå Error initializing sources registry:", err);
    });
});

// === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–ê–ú–Ø–¢–ò ===
async function getChatHistory(chatId, limit = MAX_HISTORY_MESSAGES) {
  try {
    const result = await pool.query(
      `
        SELECT role, content
        FROM chat_memory
        WHERE chat_id = $1
        ORDER BY id DESC
        LIMIT $2
      `,
      [chatId, limit]
    );
    // –≤ –ë–î –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É, –≤ –ò–ò ‚Äî –æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º
    return result.rows.reverse().map((row) => ({
      role: row.role,
      content: row.content,
    }));
  } catch (err) {
    console.error("‚ùå getChatHistory DB error:", err);
    return [];
  }
}

// –∞–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ MAX_HISTORY_MESSAGES –∑–∞–ø–∏—Å–µ–π
// ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –≤ –≠–¢–ê–ü–ï 3.6 –º—ã –µ—ë –±–æ–ª—å—à–µ –ù–ï –≤—ã–∑—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–º—è—Ç—å.
// –§—É–Ω–∫—Ü–∏—é –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ –±—É–¥—É—â–µ–µ (–¥–ª—è —Ä–µ–∑—é–º–∏—Ä–æ–≤–∞–Ω–∏—è/–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è).
async function cleanupChatHistory(chatId, maxMessages = MAX_HISTORY_MESSAGES) {
  try {
    const res = await pool.query(
      `
        SELECT id
        FROM chat_memory
        WHERE chat_id = $1
        ORDER BY id DESC
        OFFSET $2
      `,
      [chatId, maxMessages]
    );

    if (res.rows.length === 0) return;

    const idsToDelete = res.rows.map((r) => r.id);

    await pool.query(
      `
        DELETE FROM chat_memory
        WHERE id = ANY($1::int[])
      `,
      [idsToDelete]
    );

    console.log(
      `üßπ cleanupChatHistory: —É–¥–∞–ª–µ–Ω–æ ${idsToDelete.length} —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è —á–∞—Ç–∞ ${chatId}`
    );
  } catch (err) {
    console.error("‚ùå cleanupChatHistory DB error:", err);
  }
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥—É–±–ª–µ–π –ø–æ–¥—Ä—è–¥ (–≠–¢–ê–ü 3.6)
async function saveMessageToMemory(chatId, role, content) {
  if (!content || !content.trim()) return;

  try {
    // –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —ç—Ç–æ–º —á–∞—Ç–µ
    const lastRes = await pool.query(
      `
        SELECT role, content
        FROM chat_memory
        WHERE chat_id = $1
        ORDER BY id DESC
        LIMIT 1
      `,
      [chatId]
    );

    const last = lastRes.rows[0];
    if (last && last.role === role && last.content === content) {
      // –¢–æ—á–Ω–æ —Ç–∞–∫–æ–π –∂–µ —Ç–µ–∫—Å—Ç —É–∂–µ –ø–æ—Å–ª–µ–¥–Ω–∏–º ‚Äî –¥—É–±–ª—å –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º
      return;
    }

    await pool.query(
      `
        INSERT INTO chat_memory (chat_id, role, content)
        VALUES ($1, $2, $3)
      `,
      [chatId, role, content]
    );
  } catch (err) {
    console.error("‚ùå saveMessageToMemory DB error:", err);
  }
}

async function saveChatPair(chatId, userText, assistantText) {
  try {
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø–æ—Ç–æ–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
    await saveMessageToMemory(chatId, "user", userText);
    await saveMessageToMemory(chatId, "assistant", assistantText);

    // –í–ê–ñ–ù–û: –±–æ–ª—å—à–µ –Ω–µ —á–∏—Å—Ç–∏–º –∏—Å—Ç–æ—Ä–∏—é. –î–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è.
    // await cleanupChatHistory(chatId, MAX_HISTORY_MESSAGES);
  } catch (err) {
    console.error("‚ùå saveChatPair DB error:", err);
  }
}

// === USER PROFILE HANDLING ===
async function ensureUserProfile(msg) {
  const chatId = msg.chat.id.toString();
  const nameFromTelegram = msg.from?.first_name || null;

  let role = "guest";
  let finalName = nameFromTelegram;

  // –º–æ–Ω–∞—Ä—Ö
  if (chatId === "677128443") {
    role = "monarch";
    finalName = "GARY";
  }

  try {
    const existing = await pool.query(
      "SELECT * FROM users WHERE chat_id = $1",
      [chatId]
    );

    if (existing.rows.length === 0) {
      await pool.query(
        `
          INSERT INTO users (chat_id, name, role, language)
          VALUES ($1, $2, $3, $4)
        `,
        [chatId, finalName, role, msg.from?.language_code || null]
      );

      console.log(`üë§ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${finalName} (${role})`);
    } else {
      const user = existing.rows[0];
      if (user.name !== finalName) {
        await pool.query("UPDATE users SET name = $1 WHERE chat_id = $2", [
          finalName,
          chatId,
        ]);
      }
    }
  } catch (err) {
    console.error("‚ùå Error in ensureUserProfile:", err);
  }
}

// === –§–£–ù–ö–¶–ò–ò –î–õ–Ø TASK ENGINE ===

// –¥–µ–º–æ-–∑–∞–¥–∞—á–∞
async function createDemoTask(userChatId) {
  const payload = {
    note: "–≠—Ç–æ –¥–µ–º–æ-–∑–∞–¥–∞—á–∞. –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥—É—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—á—ë—Ç–∞/–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.",
  };

  const result = await pool.query(
    `
      INSERT INTO tasks (user_chat_id, title, type, payload, schedule, status)
      VALUES ($1, $2, $3, $4, $5, $6)
      RETURNING id
    `,
    [
      userChatId,
      "Demo task: hello from Task Engine",
      "demo",
      payload,
      null,
      "active",
    ]
  );

  return result.rows[0].id;
}

// –æ–±—ã—á–Ω–∞—è —Ä—É—á–Ω–∞—è –∑–∞–¥–∞—á–∞ –∏–∑ /newtask
async function createManualTask(userChatId, promptText) {
  let title = promptText.trim();
  if (title.length > 60) {
    title = title.slice(0, 57) + "...";
  }

  const payload = {
    prompt: promptText.trim(),
  };

  const result = await pool.query(
    `
      INSERT INTO tasks (user_chat_id, title, type, payload, schedule, status)
      VALUES ($1, $2, $3, $4, $5, $6)
      RETURNING id, created_at
    `,
    [userChatId, title, "manual", payload, null, "active"]
  );

  return result.rows[0];
}

// —Å–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–¥–∞—á—É price_monitor –¥–ª—è BTC (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ROBOT-—Å–ª–æ—è)
async function createTestPriceMonitorTask(userChatId) {
  const payload = {
    symbol: "BTCUSDT",
    interval_minutes: 60,
    threshold_percent: 2,
  };

  const result = await pool.query(
    `
      INSERT INTO tasks (user_chat_id, title, type, payload, schedule, status)
      VALUES ($1, $2, $3, $4, $5, $6)
      RETURNING id, created_at
    `,
    [
      userChatId,
      "BTC monitor test (—Ä–∞–∑ –≤ —á–∞—Å)",
      "price_monitor",
      payload,
      "0 * * * *", // –∫–∞–∂–¥—ã–π —á–∞—Å
      "active",
    ]
  );

  return result.rows[0];
}

// –ø–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function getUserTasks(userChatId, limit = 10) {
  const result = await pool.query(
    `
      SELECT id, title, type, status, schedule, last_run, created_at
      FROM tasks
      WHERE user_chat_id = $1
      ORDER BY id DESC
      LIMIT $2
    `,
    [userChatId, limit]
  );
  return result.rows;
}

// –ø–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á—É –ø–æ id –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function getTaskById(userChatId, taskId) {
  const result = await pool.query(
    `
      SELECT id, user_chat_id, title, type, status, payload, schedule, last_run, created_at
      FROM tasks
      WHERE user_chat_id = $1 AND id = $2
      LIMIT 1
    `,
    [userChatId, taskId]
  );
  if (result.rows.length === 0) return null;
  return result.rows[0];
}

// –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–° –ó–ê–î–ê–ß–ò (pause/resume/delete)
async function updateTaskStatus(userChatId, taskId, newStatus) {
  await pool.query(
    `
      UPDATE tasks
      SET status = $1
      WHERE user_chat_id = $2 AND id = $3
    `,
    [newStatus, userChatId, taskId]
  );
}

// –∑–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ –ò–ò-–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
async function runTaskWithAI(task, chatId) {
  if (!process.env.OPENAI_API_KEY) {
    await bot.sendMessage(
      chatId,
      "–ó–∞–¥–∞—á–∞ –µ—Å—Ç—å, –Ω–æ –ò–ò —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ—Ç API –∫–ª—é—á–∞)."
    );
    return;
  }

  const promptText =
    (task.payload && (task.payload.prompt || task.payload.note)) ||
    task.title ||
    "";

  const messages = [
    {
      role: "system",
      content: `
–¢—ã ‚Äî –º–æ–¥—É–ª—å Task Engine –ö–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–∞ GARYA.
–¢–µ–±–µ –¥–∞—é—Ç –ó–ê–î–ê–ß–£, —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –æ–±—ã—á–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.
–¢–≤–æ—è —Ü–µ–ª—å ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±—É–∫–≤–∞–ª—å–Ω–æ –∏ –ø–æ–ª–µ–∑–Ω–æ –í–´–ü–û–õ–ù–ò–¢–¨ –µ—ë –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å–≤–æ–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π:
‚Äî –¥—É–º–∞—Ç—å, –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å, —Å—á–∏—Ç–∞—Ç—å, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å;
‚Äî –¥–∞–≤–∞—Ç—å —á—ë—Ç–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –∏–ª–∏ —Ä–∞—Å—á—ë—Ç—ã;
‚Äî –ø–∏—Å–∞—Ç—å –≤—Å—ë –ø–æ-—Ä—É—Å—Å–∫–∏, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.

–ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤–æ –≤–Ω–µ—à–Ω–µ–º –º–∏—Ä–µ (–¥–æ—Å—Ç—É–ø –∫ –±–∏—Ä–∂–µ, TradingView, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É, API),
–∫–æ—Ç–æ—Ä—ã—Ö —É —Ç–µ–±—è –Ω–µ—Ç, –ù–ï –ü–†–ò–¢–í–û–†–Ø–ô–°–Ø, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ.
–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ:
‚Äî –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏;
‚Äî –≤—ã–¥–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–æ–ª–µ–∑–Ω—ã–π –ø–ª–∞–Ω: –∫–∞–∫ –±—ã —Ç—ã –≤—ã–ø–æ–ª–Ω—è–ª —ç—Ç—É –∑–∞–¥–∞—á—É, –∫–∞–∫–∏–µ —à–∞–≥–∏, —Ñ–æ—Ä–º—É–ª—ã, –ø—Ä–∞–≤–∏–ª–∞.
      `,
    },
    {
      role: "user",
      content: `–ó–∞–¥–∞—á–∞ #${task.id} (${task.type}, —Å—Ç–∞—Ç—É—Å: ${task.status}).
–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ (payload.prompt/title):
"${promptText}"`,
    },
  ];

  // === –í—ã–∑–æ–≤ –ò–ò —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π —Å–ª–æ–π ai.js ===
  let reply = "";
  try {
    reply = await callAI(messages, "high");
  } catch (e) {
    console.error("‚ùå AI error:", e);
    reply = "‚ö†Ô∏è –ò–ò –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –º–æ–¥–µ–ª–∏.";
  }

  await pool.query("UPDATE tasks SET last_run = NOW() WHERE id = $1", [
    task.id,
  ]);

  await bot.sendMessage(
    chatId,
    `üöÄ –ó–∞–¥–∞—á–∞ #${task.id} –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ò–ò-–¥–≤–∏–∂–∫–æ–º.\n\n${reply}`
  );
}
