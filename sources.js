// sources.js ‚Äî —Å–∫–µ–ª–µ—Ç —Å–ª–æ—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ + MOCK –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö
import pool from "./db.js";

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
 *
 * –õ–æ–≥–∏–∫–∞:
 * 1) –ï—Å–ª–∏ –≤ –ë–î –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (—Ç–∞–±–ª–∏—Ü–∞ sources –Ω–µ –ø—É—Å—Ç–∞—è) ‚Äî
 *    –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Ö.
 * 2) –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º MOCK-–Ω–∞–±–æ—Ä "–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö" –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:
 *    - builtin_knowledge   ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ (–æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
 *    - open_web_generic    ‚Äî –æ–±—â–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏
 *    - mock_price_feed     ‚Äî —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∏–¥ —Ü–µ–Ω –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ API
 *
 * –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º:
 * - –∞–≥–µ–Ω—Ç –º–æ–∂–µ—Ç —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∑–∞—Ç—å, –æ—Ç–∫—É–¥–∞ —É—Å–ª–æ–≤–Ω–æ –±–µ—Ä—ë—Ç –¥–∞–Ω–Ω—ã–µ,
 * - –¥–∞–∂–µ –µ—Å–ª–∏ —É –º–æ–Ω–∞—Ä—Ö–∞ —Å–µ–π—á–∞—Å –ù–ï–¢ —Ä–µ–∞–ª—å–Ω—ã—Ö API/—Ä–µ—Å—É—Ä—Å–æ–≤.
 */
export async function listActiveSources() {
  try {
    const res = await pool.query(
      `
        SELECT
          id,
          key,
          name,
          type,
          url,
          is_enabled,
          config,
          created_at
        FROM sources
        WHERE is_enabled = TRUE
        ORDER BY id ASC
      `
    );

    const rows = res.rows || [];

    // üîπ –ï—Å–ª–∏ –≤ –ë–î —É–∂–µ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ ‚Äî –æ—Ç–¥–∞–µ–º –∏—Ö –∫–∞–∫ –µ—Å—Ç—å
    if (rows.length > 0) {
      return rows;
    }

    // üîπ –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º MOCK-–∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ)
    const now = new Date();

    return [
      {
        id: 0,
        key: "builtin_knowledge",
        name: "–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ (–æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)",
        type: "builtin",
        url: null,
        is_enabled: true,
        config: null,
        created_at: now,
      },
      {
        id: -1,
        key: "open_web_generic",
        name:
          "–û–±—â–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ª–Ω–æ—Ç—ã)",
        type: "open_web",
        url: null,
        is_enabled: true,
        config: null,
        created_at: now,
      },
      {
        id: -2,
        key: "mock_price_feed",
        name: "–¢–µ—Å—Ç–æ–≤—ã–π mock-—Ñ–∏–¥ —Ü–µ–Ω (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –±–∏—Ä–∂–µ–≤–æ–≥–æ API)",
        type: "mock",
        url: null,
        is_enabled: true,
        config: {
          symbols: ["BTCUSDT", "ETHUSDT", "SOLUSDT"],
        },
        created_at: now,
      },
    ];
  } catch (err) {
    console.error("‚ùå listActiveSources DB error:", err);

    // –ï—Å–ª–∏ –¥–∞–∂–µ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π MOCK,
    // —á—Ç–æ–±—ã /sources –Ω–µ –ø–∞–¥–∞–ª–∞ –∏ –∞–≥–µ–Ω—Ç –º–æ–≥ —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
    // —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –∑–Ω–∞–Ω–∏–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö API.
    const now = new Date();

    return [
      {
        id: 0,
        key: "builtin_knowledge",
        name: "–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ (fallback, –±–µ–∑ –ë–î)",
        type: "builtin",
        url: null,
        is_enabled: true,
        config: null,
        created_at: now,
      },
    ];
  }
}
